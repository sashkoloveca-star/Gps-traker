<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<title>GPS Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    text-align: center;
}

h2 {
    background: #2196f3;
    color: white;
    margin: 0;
    padding: 12px;
}

#status {
    padding: 10px;
    font-weight: bold;
}

.status-ok {
    background: #4CAF50;
    color: white;
}

.status-error {
    background: #F44336;
    color: white;
}

#map {
    height: 60vh;
    width: 100%;
}

.controls {
    padding: 10px;
    background: white;
}

button {
    padding: 12px 20px;
    margin: 5px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
}

.start { background: #4CAF50; }
.stop  { background: #F44336; }

ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

li {
    padding: 10px;
    background: white;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
}
li:hover {
    background: #e0e0e0;
}
</style>
</head>

<body>

<h2>üìç GPS –ü—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ</h2>

<div id="status"></div>
<div id="map"></div>

<div class="controls">
    <button class="start" onclick="startTracking()">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
    <button class="stop" onclick="stopTracking()">‚èπ –°—Ç–æ–ø</button>
</div>

<h3>üïí –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è</h3>
<ul id="history"></ul>

<script>
/* ============ STATUS ============ */
const statusDiv = document.getElementById("status");
const isSecure =
    location.protocol === "https:" ||
    location.hostname === "localhost" ||
    location.hostname === "127.0.0.1";

if (isSecure) {
    statusDiv.className = "status-ok";
    statusDiv.innerText = "‚úÖ HTTPS / Localhost ‚Äì GPS —Ä–∞–∑—Ä–µ—à–µ–Ω";
} else {
    statusDiv.className = "status-error";
    statusDiv.innerText = "‚ùå GPS —Ä–∞–±–æ—Ç–∏ —Å–∞–º–æ –ø—Ä–µ–∑ HTTPS / Localhost";
}

/* ============ MAP ============ */
let map = L.map("map").setView([42.6977, 23.3219], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
}).addTo(map);

let polyline = L.polyline([], { color: "blue", weight: 6 }).addTo(map);

/* ============ ICON ============ */
const gpsIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
    iconSize: [40, 40],
    iconAnchor: [20, 40]
});

let marker = null;

/* ============ GPS ============ */
let watchId = null;
let currentRoute = [];
let currentRouteId = null;

/* ============ START ============ */
function startTracking() {
    if (!isSecure) {
        alert("GPS —Ä–∞–±–æ—Ç–∏ —Å–∞–º–æ –ø—Ä–µ–∑ HTTPS –∏–ª–∏ localhost");
        return;
    }

    if (!navigator.geolocation) {
        alert("–ë—Ä–∞—É–∑—ä—Ä—ä—Ç –Ω–µ –ø–æ–¥–¥—ä—Ä–∂–∞ GPS");
        return;
    }

    currentRouteId = Date.now();
    currentRoute = [];
    polyline.setLatLngs([]);

    if (marker) {
        map.removeLayer(marker);
        marker = null;
    }

    watchId = navigator.geolocation.watchPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            currentRoute.push({ lat, lng, time: Date.now() });
            polyline.addLatLng([lat, lng]);

            if (!marker) {
                marker = L.marker([lat, lng], { icon: gpsIcon }).addTo(map);
            } else {
                marker.setLatLng([lat, lng]);
            }

            map.setView([lat, lng], 17);
        },
        err => {
            alert("GPS –≥—Ä–µ—à–∫–∞: " + err.message);
        },
        {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        }
    );
}

/* ============ STOP ============ */
function stopTracking() {
    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;

        if (currentRoute.length > 0) {
            saveRoute();
            loadHistory();
        }
    }
}

/* ============ SAVE ============ */
function saveRoute() {
    let routes = JSON.parse(localStorage.getItem("routes")) || [];
    routes.push({
        id: currentRouteId,
        points: currentRoute
    });
    localStorage.setItem("routes", JSON.stringify(routes));
}

/* ============ HISTORY ============ */
function loadHistory() {
    let history = document.getElementById("history");
    history.innerHTML = "";

    let routes = JSON.parse(localStorage.getItem("routes")) || [];

    routes.forEach(route => {
        let li = document.createElement("li");
        li.innerText = new Date(route.id).toLocaleString();
        li.onclick = () => showRoute(route.points);
        history.appendChild(li);
    });
}

/* ============ SHOW ROUTE ============ */
function showRoute(points) {
    polyline.setLatLngs([]);
    points.forEach(p => polyline.addLatLng([p.lat, p.lng]));

    if (marker) {
        map.removeLayer(marker);
        marker = null;
    }

    if (points.length > 0) {
        marker = L.marker(
            [points[points.length - 1].lat, points[points.length - 1].lng],
            { icon: gpsIcon }
        ).addTo(map);

        map.setView([points[0].lat, points[0].lng], 15);
    }
}

/* ============ INIT ============ */
loadHistory();
</script>

</body>
</html>
